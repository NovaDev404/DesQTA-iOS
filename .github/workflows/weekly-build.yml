name: Weekly Build

on:
  schedule:
    - cron: '0 2 * * 0' # Runs weekly on Sunday at 02:00 UTC
  workflow_dispatch:

jobs:
  nightly-build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest]

    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Install dependencies
        run: npm install

      - name: Install zip (Windows)
        if: runner.os == 'Windows'
        run: choco install zip -y

      - name: Build app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build

      - name: Upload build artifacts (workflow run)
        uses: actions/upload-artifact@v4
        with:
          name: nightly-tauri-build-${{ matrix.os }}-${{ github.ref_name }}
          path: src-tauri/target/release/bundle/**

      - name: Get build time
        id: build_time
        run: echo "BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT

      # Removed GitHub Release publishing. Artifacts are attached to this workflow run only.

  nightly-ios-build:
    runs-on: macos-latest

    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,x86_64-apple-ios

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Install dependencies
        run: npm install

      - name: Ensure CocoaPods is available
        run: |
          pod --version || sudo gem install cocoapods

      - name: Clean stale iOS generated project
        run: |
          rm -rf src-tauri/gen/apple
          rm -rf src-tauri/gen/ios

      - name: Initialize iOS project (CI)
        env:
          CI: true
        run: npm run tauri -- ios init --ci --reinstall-deps

      - name: Verify generated iOS project files
        id: ios_generated
        run: |
          if [ ! -d src-tauri/gen ]; then
            echo "Missing generated mobile directory: src-tauri/gen"
            exit 1
          fi

          XCODE_WORKSPACE=$(find src-tauri/gen -name '*.xcworkspace' | head -1)
          XCODE_PROJECT=$(find src-tauri/gen -name '*.xcodeproj' | head -1)
          XCODE_SCHEME=$(find src-tauri/gen -name '*.xcscheme' | head -1)
          IOS_PROJECT_ROOT=""
          if [ -n "$XCODE_WORKSPACE" ]; then
            IOS_PROJECT_ROOT=$(dirname "$XCODE_WORKSPACE")
          elif [ -n "$XCODE_PROJECT" ]; then
            IOS_PROJECT_ROOT=$(dirname "$XCODE_PROJECT")
          fi

          if [ -z "$XCODE_SCHEME" ]; then
            echo "No iOS scheme found under src-tauri/gen"
            exit 1
          fi

          if [ -z "$XCODE_WORKSPACE" ] && [ -z "$XCODE_PROJECT" ]; then
            echo "No iOS Xcode workspace/project found under src-tauri/gen"
            exit 1
          fi

          if [ -z "$IOS_PROJECT_ROOT" ]; then
            echo "Unable to resolve iOS project root"
            exit 1
          fi

          echo "Found iOS container and scheme:"
          [ -n "$XCODE_WORKSPACE" ] && echo "Workspace: $XCODE_WORKSPACE"
          [ -n "$XCODE_PROJECT" ] && echo "Project: $XCODE_PROJECT"
          echo "Scheme: $XCODE_SCHEME"
          echo "Project root: $IOS_PROJECT_ROOT"
          echo "project_root=$IOS_PROJECT_ROOT" >> $GITHUB_OUTPUT

      - name: Build iOS Simulator (unsigned)
        env:
          CI: true
        run: |
          npm run tauri -- ios build --ci --target aarch64-sim

      - name: Snapshot simulator build outputs
        run: |
          IOS_PROJECT_ROOT='${{ steps.ios_generated.outputs.project_root }}'
          rm -rf "$IOS_PROJECT_ROOT/build-simulator"
          if [ ! -d "$IOS_PROJECT_ROOT/build" ]; then
            echo "Expected build output at $IOS_PROJECT_ROOT/build"
            exit 1
          fi
          cp -R "$IOS_PROJECT_ROOT/build" "$IOS_PROJECT_ROOT/build-simulator"

      - name: Build iOS Device (unsigned)
        env:
          CI: true
        run: |
          npm run tauri -- ios build --ci --target aarch64 --export-method debugging

      - name: Snapshot device build outputs
        run: |
          IOS_PROJECT_ROOT='${{ steps.ios_generated.outputs.project_root }}'
          rm -rf "$IOS_PROJECT_ROOT/build-device"
          if [ ! -d "$IOS_PROJECT_ROOT/build" ]; then
            echo "Expected build output at $IOS_PROJECT_ROOT/build"
            exit 1
          fi
          cp -R "$IOS_PROJECT_ROOT/build" "$IOS_PROJECT_ROOT/build-device"

      - name: Package iOS build outputs
        run: |
          IOS_PROJECT_ROOT='${{ steps.ios_generated.outputs.project_root }}'
          mkdir -p "$IOS_PROJECT_ROOT/artifacts"
          cd "$IOS_PROJECT_ROOT"
          zip -r artifacts/ios-simulator-release.zip build-simulator || true
          zip -r artifacts/ios-device-unsigned-release.zip build-device || true

      - name: Upload iOS build artifacts (workflow run)
        uses: actions/upload-artifact@v4
        with:
          name: nightly-ios-build-${{ github.ref_name }}
          path: |
            src-tauri/gen/**/artifacts/ios-simulator-release.zip
            src-tauri/gen/**/artifacts/ios-device-unsigned-release.zip
