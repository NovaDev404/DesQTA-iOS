name: Build DesQTA

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-desktop:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Install dependencies
        run: npm i

      - name: Build desktop app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npm run tauri build

      - name: Upload desktop build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-builds-${{ matrix.os }}
          path: src-tauri/target/release/bundle/**

  build-android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android

      - name: Install Android SDK
        uses: android-actions/setup-android@v3
        with:
          sdk-platform: '34'
          sdk-build-tools: '34.0.0'
          ndk-version: '25.2.9519653'
          cmake-version: '3.22.1'

      - name: Set up Android environment
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "GRADLE_OPTS=-Dorg.gradle.java.home=$JAVA_HOME -Xmx4g -XX:+HeapDumpOnOutOfMemoryError" >> $GITHUB_ENV
          echo "PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_NDK_HOME" >> $GITHUB_ENV

          # Debug: Print environment variables
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo "NDK_HOME: $NDK_HOME"
          echo "JAVA_HOME: $JAVA_HOME"
          echo "GRADLE_OPTS: $GRADLE_OPTS"

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Install dependencies
        run: npm i

      - name: Accept Android licenses
        run: |
          yes | sdkmanager --licenses || true

      - name: Verify NDK installation
        run: |
          echo "Checking NDK installation..."
          ls -la $ANDROID_NDK_HOME
          echo "NDK version:"
          $ANDROID_NDK_HOME/ndk-build --version || echo "ndk-build not found"
          echo "Available NDK tools:"
          ls -la $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/ | head -10

      - name: Fix Gradle Java home
        run: |
          echo "Fixing Gradle Java home for Linux..."

          # Check if gradle.properties exists and show current content
          echo "Current gradle.properties content:"
          cat src-tauri/gen/android/gradle.properties || echo "gradle.properties not found"

          # Create gradle.properties with all necessary properties
          cat > src-tauri/gen/android/gradle.properties << EOF
          org.gradle.java.home=$JAVA_HOME
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.daemon=false
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          EOF

          # Also check and fix gradle-wrapper.properties if needed
          echo "Current gradle-wrapper.properties content:"
          cat src-tauri/gen/android/gradle/wrapper/gradle-wrapper.properties || echo "gradle-wrapper.properties not found"

          echo "Fixed gradle.properties:"
          cat src-tauri/gen/android/gradle.properties

          echo "JAVA_HOME value: $JAVA_HOME"

      - name: Build Android APK
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          echo "Building with JAVA_HOME: $JAVA_HOME"
          echo "Building with GRADLE_OPTS: $GRADLE_OPTS"
          JAVA_HOME=$JAVA_HOME GRADLE_OPTS="-Dorg.gradle.java.home=$JAVA_HOME -Xmx4g -XX:+HeapDumpOnOutOfMemoryError" npm run tauri android build

      - name: Zip Android build outputs
        run: |
          cd src-tauri/gen/android/app/build
          zip -r outputs.zip outputs || true

      - name: Upload Android build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build-outputs
          path: src-tauri/gen/android/app/build/outputs.zip

  build-ios:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,x86_64-apple-ios

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Install dependencies
        run: npm i

      - name: Install iOS build tooling
        run: |
          brew update
          brew install xcodegen libimobiledevice cocoapods
          brew link --overwrite cocoapods || true
          echo "PATH=$(brew --prefix)/bin:$PATH" >> $GITHUB_ENV
          which pod
          pod --version

      - name: Clean stale iOS generated project
        run: |
          rm -rf src-tauri/gen/apple
          rm -rf src-tauri/gen/ios

      - name: Initialize iOS project (CI)
        env:
          CI: true
        run: npm run tauri -- ios init --ci

      - name: Verify generated iOS project files
        id: ios_generated
        run: |
          if [ ! -d src-tauri/gen ]; then
            echo "Missing generated mobile directory: src-tauri/gen"
            exit 1
          fi

          XCODE_WORKSPACE=$(find src-tauri/gen -name '*.xcworkspace' | head -1)
          XCODE_PROJECT=$(find src-tauri/gen -name '*.xcodeproj' | head -1)
          XCODE_SCHEME=$(find src-tauri/gen -name '*.xcscheme' | head -1)
          IOS_PROJECT_ROOT=""
          if [ -n "$XCODE_WORKSPACE" ]; then
            IOS_PROJECT_ROOT=$(dirname "$XCODE_WORKSPACE")
          elif [ -n "$XCODE_PROJECT" ]; then
            IOS_PROJECT_ROOT=$(dirname "$XCODE_PROJECT")
          fi

          if [[ "$IOS_PROJECT_ROOT" == *.xcodeproj ]]; then
            IOS_PROJECT_ROOT=$(dirname "$IOS_PROJECT_ROOT")
          fi

          if [ -z "$XCODE_SCHEME" ]; then
            echo "No iOS scheme found under src-tauri/gen"
            exit 1
          fi

          if [ -z "$XCODE_WORKSPACE" ] && [ -z "$XCODE_PROJECT" ]; then
            echo "No iOS Xcode workspace/project found under src-tauri/gen"
            exit 1
          fi

          if [ -z "$IOS_PROJECT_ROOT" ]; then
            echo "Unable to resolve iOS project root"
            exit 1
          fi

          echo "Found iOS container and scheme:"
          [ -n "$XCODE_WORKSPACE" ] && echo "Workspace: $XCODE_WORKSPACE"
          [ -n "$XCODE_PROJECT" ] && echo "Project: $XCODE_PROJECT"
          echo "Scheme: $XCODE_SCHEME"
          echo "Project root: $IOS_PROJECT_ROOT"
          echo "project_root=$IOS_PROJECT_ROOT" >> $GITHUB_OUTPUT

      - name: Build iOS Simulator (unsigned)
        env:
          CI: true
        run: |
          npm run tauri -- ios build --ci --target aarch64-sim

      - name: Snapshot simulator build outputs
        run: |
          IOS_PROJECT_ROOT="${{ steps.ios_generated.outputs.project_root }}"
          rm -rf "$IOS_PROJECT_ROOT/build-simulator"
          if [ ! -d "$IOS_PROJECT_ROOT/build" ]; then
            echo "Expected build output at $IOS_PROJECT_ROOT/build"
            exit 1
          fi
          cp -R "$IOS_PROJECT_ROOT/build" "$IOS_PROJECT_ROOT/build-simulator"

      - name: Build iOS Device (unsigned)
        env:
          CI: true
        run: |
          npm run tauri -- ios build --ci --target aarch64 --export-method debugging

      - name: Snapshot device build outputs
        run: |
          IOS_PROJECT_ROOT="${{ steps.ios_generated.outputs.project_root }}"
          rm -rf "$IOS_PROJECT_ROOT/build-device"
          if [ ! -d "$IOS_PROJECT_ROOT/build" ]; then
            echo "Expected build output at $IOS_PROJECT_ROOT/build"
            exit 1
          fi
          cp -R "$IOS_PROJECT_ROOT/build" "$IOS_PROJECT_ROOT/build-device"

      - name: Package iOS build outputs
        run: |
          IOS_PROJECT_ROOT="${{ steps.ios_generated.outputs.project_root }}"
          mkdir -p "$IOS_PROJECT_ROOT/artifacts"
          cd "$IOS_PROJECT_ROOT"
          zip -r artifacts/ios-simulator-release.zip build-simulator || true
          zip -r artifacts/ios-device-unsigned-release.zip build-device || true

      - name: Upload iOS build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-outputs
          path: |
            src-tauri/gen/**/artifacts/ios-simulator-release.zip
            src-tauri/gen/**/artifacts/ios-device-unsigned-release.zip
